
## Building LMDB

Get the stuff:

```console
cd ~
git clone https://github.com/LMDB/lmdb.git
cd lmdb
git checkout LMDB_0.9.15
cd libraries/liblmdb/
```

Now edit `Makefile` for:

```
OPT = -O3 -march=native -mtune=native
```

and do

```console
make
```

> Note: the Makefile is a mess: it doesn't allow overriding compile flags from env var CFLAGS e.g., and the install step doesn't work properly.

The 3 important files we will need are

```console
oberstet@bvr-sql18:~/scm/lmdb/libraries/liblmdb> ls -la lmdb.h liblmdb.so liblmdb.a
-rw-r--r-- 1 oberstet users 596532 Jun 24 17:21 liblmdb.a
-rwxr-xr-x 1 oberstet users 287473 Jun 24 17:21 liblmdb.so
-rw-r--r-- 1 oberstet users  71462 Jun 23 16:25 lmdb.h
```

When stripping the SO, we can get it down to 80kB:

```console
oberstet@bvr-sql18:~/scm/lmdb/libraries/liblmdb> strip liblmdb.so
oberstet@bvr-sql18:~/scm/lmdb/libraries/liblmdb> size liblmdb.so
   text    data     bss     dec     hex filename
  75810    1424       8   77242   12dba liblmdb.so
oberstet@bvr-sql18:~/scm/lmdb/libraries/liblmdb> ls -la liblmdb.so
-rwxr-xr-x 1 oberstet users 80696 Jun 24 17:27 liblmdb.so
```

This is very nice. LMDB is **tiny**.

## Building db_bench_mdb

The build system for this also a mess. The following should be considered "a hack":

```console
git clone https://github.com/hyc/leveldb.git
cd leveldb
git checkout 8cb4ce7
```

Now apply the following patch to `Makefile`:

```
diff --git a/Makefile b/Makefile
index a454085..281d353 100644
--- a/Makefile
+++ b/Makefile
@@ -6,7 +6,7 @@
 # Uncomment exactly one of the lines labelled (A), (B), and (C) below
 # to switch between compilation modes.

-OPT ?= -O2 -DNDEBUG       # (A) Production use (optimized mode)
+OPT ?= -O3 -march=native -mtune=native -DNDEBUG       # (A) Production use (optimized mode)
 # OPT ?= -g2              # (B) Debug mode, w/ full line-level debugging symbols
 # OPT ?= -O2 -g2 -DNDEBUG # (C) Profiling mode: opt, but w/debugging symbols
 #-----------------------------------------------
@@ -17,8 +17,8 @@ $(shell CC="$(CC)" CXX="$(CXX)" TARGET_OS="$(TARGET_OS)" \
 # this file is generated by the previous line to set build flags and sources
 include build_config.mk

-CFLAGS += -I. -I./include $(PLATFORM_CCFLAGS) $(OPT)
-CXXFLAGS += -I. -I./include $(PLATFORM_CXXFLAGS) $(OPT)
+CFLAGS += -I. -I./include -I$(HOME)/scm/lmdb/libraries/liblmdb/ $(PLATFORM_CCFLAGS) $(OPT)
+CXXFLAGS += -std=c++11 -I. -I./include -I$(HOME)/scm/lmdb/libraries/liblmdb/ $(PLATFORM_CXXFLAGS) $(OPT)

 LDFLAGS += $(PLATFORM_LDFLAGS)
 LIBS += $(PLATFORM_LIBS)
@@ -155,7 +155,7 @@ db_bench_forestdb: doc/bench/db_bench_forestdb.o $(LIBRARY) $(TESTUTIL)
        $(CXX) doc/bench/db_bench_forestdb.o $(LIBRARY) $(TESTUTIL) -o $@ $(LDFLAGS) /usr/local/lib/libforestdb.a

 db_bench_mdb: doc/bench/db_bench_mdb.o $(LIBRARY) $(TESTUTIL)
-       $(CXX) doc/bench/db_bench_mdb.o $(LIBRARY) $(TESTUTIL) -o $@ $(LDFLAGS) /usr/local/lib/liblmdb.a
+       $(CXX) doc/bench/db_bench_mdb.o $(LIBRARY) $(TESTUTIL) -o $@ $(LDFLAGS) $(HOME)/scm/lmdb/libraries/liblmdb/liblmdb.a

 db_bench_bdb: doc/bench/db_bench_bdb.o $(LIBRARY) $(TESTUTIL)
        $(CXX) doc/bench/db_bench_bdb.o $(LIBRARY) $(TESTUTIL) -o $@ $(LDFLAGS) /usr/local/lib/libdb.a
```

and then

```console
make db_bench_mdb
strip db_bench_mdb
```

This will produce:

```console
oberstet@bvr-sql18:~/scm/lmdb_bench> ls -la db_bench_mdb
-rwxr-xr-x 1 oberstet users 142984 Jun 24 17:51 db_bench_mdb
oberstet@bvr-sql18:~/scm/lmdb_bench> size db_bench_mdb
   text    data     bss     dec     hex filename
 135481    1944     624  138049   21b41 db_bench_mdb
oberstet@bvr-sql18:~/scm/lmdb_bench> ldd db_bench_mdb
        linux-vdso.so.1 (0x00007ffe3319f000)
        libstdc++.so.6 => /usr/lib64/libstdc++.so.6 (0x00007f9196f6f000)
        libm.so.6 => /lib64/libm.so.6 (0x00007f9196c6e000)
        libgcc_s.so.1 => /lib64/libgcc_s.so.1 (0x00007f9196a56000)
        libpthread.so.0 => /lib64/libpthread.so.0 (0x00007f9196839000)
        libc.so.6 => /lib64/libc.so.6 (0x00007f9196491000)
        /lib64/ld-linux-x86-64.so.2 (0x00007f9197290000)
oberstet@bvr-sql18:~/scm/lmdb_bench>
```
